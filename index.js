require('dotenv').config()
const express = require('express');
const bodyParser = require('body-parser');
const schedule = require('node-schedule');
const VkBot = require('node-vk-bot-api/lib');
const Markup = require('node-vk-bot-api/lib/markup');
const Session = require('node-vk-bot-api/lib/session');
const Stage = require('node-vk-bot-api/lib/stage');
const { getCurrentDuties } = require('./commands');
const { fillScheduleByLastDuties } = require('./commands');
const { changeDuties } = require('./scenes');
const { checkAndRemindDuties  } = require('./execute');


const logger = require('./logger');
const expressPino = require('express-pino-logger');
const expressLogger = expressPino({ logger });

const app = express();
const bot = new VkBot({
    token: process.env.VK_TOKEN,
    confirmation: process.env.VK_CONFIRM
});
const session = new Session();
const stage = new Stage(changeDuties);

bot.use(session.middleware());

bot.use(stage.middleware());

bot.command(/–ú–µ–Ω—é+$/i, ctx => {
    ctx.reply('–í—ã–±–µ—Ä–∏ —Ä–∞–∑–¥–µ–ª:', null, Markup
      .keyboard([
        [
          Markup.button('–î–µ–∂—É—Ä—Å—Ç–≤–∞', 'primary'),
          Markup.button('–†–∞–∑–¥–µ–ª—å–Ω—ã–π', 'primary')
        ],
        [
          Markup.button('–ë–∞–Ω–∫', 'primary'),
          Markup.button('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è', 'primary')
        ]
      ])
    );
});

bot.command(/–î–µ–∂—É—Ä—Å—Ç–≤–∞+$/i, ctx => {
  try {
    ctx.reply('–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:', null, Markup
      .keyboard([
        [
          Markup.button('–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏—Ö', 'positive'),
          Markup.button('–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏—Ö', 'negative')
        ],
        [
          Markup.button('–ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞'),
          Markup.button({
            action: {
              type: 'open_link',
              link: `https://docs.google.com/spreadsheets/d/${process.env.SPREADSHEET_ID}`,
              label: '–û—Ç–∫—Ä—ã—Ç—å –≥—É–≥–ª-—Ç–∞–±–ª–∏—Ü—É',
              payload: JSON.stringify({ url: `https://docs.google.com/spreadsheets/d/${process.env.SPREADSHEET_ID}` })
            }
          }),
        ],
        [
          Markup.button('–ß–µ–∫-–ª–∏—Å—Ç –∫—É—Ö–Ω–∏'),
          Markup.button('–ß–µ–∫-–ª–∏—Å—Ç –ö–í–¢'),
          Markup.button('–ú–µ–Ω—é', 'primary'),
        ]
      ])
    );
  } catch (error) {
    logger.error(error);
  }
});

bot.command(/–ü–æ–∫–∞–∑–∞—Ç—å\s—Ç–µ–∫—É—â–∏—Ö+$/i, getCurrentDuties);

bot.command(/–ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ\s–≥—Ä–∞—Ñ–∏–∫–∞+$/i, fillScheduleByLastDuties);

bot.command(/–¢–µ—Å—Ç+$/i, ctx => {
    ctx.reply('–†–µ–±—è—Ç–∞ –Ω–µ —Å—Ç–æ–∏—Ç –≤—Å–∫—Ä—ã–≤–∞—Ç—å —ç—Ç—É —Ç–µ–º—É. –í—ã –º–æ–ª–æ–¥—ã–µ, —à—É—Ç–ª–∏–≤—ã–µ, –≤–∞–º –≤—Å–µ –ª–µ–≥–∫–æ. –≠—Ç–æ –Ω–µ —Ç–æ. –≠—Ç–æ –Ω–µ –ß–∏–∫–∞—Ç–∏–ª–æ –∏ –¥–∞–∂–µ –Ω–µ –∞—Ä—Ö–∏–≤—ã —Å–ø–µ—Ü—Å–ª—É–∂–±. –°—é–¥–∞ –ª—É—á—à–µ –Ω–µ –ª–µ–∑—Ç—å. –°–µ—Ä—å–µ–∑–Ω–æ, –ª—é–±–æ–π –∏–∑ –≤–∞—Å –±—É–¥–µ—Ç –∂–∞–ª–µ—Ç—å. –õ—É—á—à–µ –∑–∞–∫—Ä–æ–π—Ç–µ —Ç–µ–º—É –∏ –∑–∞–±—É–¥—å—Ç–µ —á—Ç–æ —Ç—É—Ç –ø–∏—Å–∞–ª–æ—Å—å. –Ø –≤–ø–æ–ª–Ω–µ –ø–æ–Ω–∏–º–∞—é —á—Ç–æ –¥–∞–Ω–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –≤—ã–∑–æ–≤—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–µ—Å, –Ω–æ —Ö–æ—á—É —Å—Ä–∞–∑—É –ø—Ä–µ–¥–æ—Å—Ç–µ—Ä–µ—á—å –ø—ã—Ç–ª–∏–≤—ã—Ö - —Å—Ç–æ–ø. –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Å—Ç–æ –Ω–µ –Ω–∞–π–¥—É—Ç.');
});

bot.command(/–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏—Ö+$/i, ctx => {
  ctx.scene.enter('Change Duties');
});

bot.command(/–ß–µ–∫-–ª–∏—Å—Ç –∫—É—Ö–Ω–∏+$/i, ctx => {
  ctx.reply(`üçΩ –ö—É—Ö–Ω—è:

              1. –í—ã–º—ã—Ç—å —Ä–∞–∫–æ–≤–∏–Ω—É —Å –º–æ—é—â–∏–º —Å—Ä–µ–¥—Å—Ç–≤–æ–º.
              2. –í—ã–º—ã—Ç—å —Å—É—à–∏–ª–∫–∏-–ø–æ–¥—Å—Ç–∞–≤–∫–∏ –¥–ª—è –ª–æ–∂–µ–∫ –∏ –≤–∏–ª–æ–∫.
              3. –£–±—Ä–∞—Ç—å—Å—è (—á—Ç–æ–±—ã –≤—Å–µ –ª–µ–∂–∞–ª–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ) –Ω–∞ –ø–æ–¥–æ–∫–æ–Ω–Ω–∏–∫–µ –∏ –Ω–∞ –ø–æ–ª–∫–µ –Ω–∞–¥ —Å—Ç–∏—Ä–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–æ–π.
              4. –£–±—Ä–∞—Ç—å—Å—è (–ø—Ä–æ—Ç–µ—Ä–µ—Ç—å –∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Ä–∞—Å—Å—Ç–∞–≤–∏—Ç—å) –Ω–∞ –ø–æ–ª–∫–∞—Ö - —Å —á–∞–µ–º, —Å–ø–µ—Ü–∏—è–º–∏.
              5. –•–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –≤—ã–º—ã—Ç—å –≤–Ω—É—Ç—Ä–∏, —Å–Ω–∞—Ä—É–∂–∏ –∏ –≤—ã–∫–∏–Ω—É—Ç—å –≥–Ω–∏–ª—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã, —Å–ª–µ–¥–∏—Ç—å, —á—Ç–æ–±—ã –≤—Å–µ —Ö—Ä–∞–Ω–∏–ª–æ—Å—å –∞–∫–∫—É—Ä–∞—Ç–Ω–æ.
              6. –¢—É –ø–æ—Å—É–¥—É, –∫–æ—Ç–æ—Ä—É—é –∑–∞–±—ã–≤–∞—é—Ç –ø–æ–º—ã—Ç—å, –º—ã—Ç—å (—ç—Ç–æ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –ø–æ—á—Ç–∏).
              7. –ü—Ä–æ—Ç–∏—Ä–∞—Ç—å –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏, –ø–æ–¥–æ–∫–æ–Ω–Ω–∏–∫, —Å—Ç–∏—Ä–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É (–≤–Ω—É—Ç—Ä–∏ –º—ã—Ç—å —Ç–æ–∂–µ).
              8. –£–±–∏—Ä–∞—Ç—å –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –ø–æ–¥ —Ä–∞–∫–æ–≤–∏–Ω–æ–π.
              9. –í—ã–º—ã—Ç—å –ø–æ–ª.
              10. –ü–æ–¥–º–µ—Ç–∞—Ç—å –ø–æ–ª, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—Å—Ç–∞—Ç–∫–æ–≤ –µ–¥—ã.
              11. –°–ª–µ–¥–∏—Ç—å –∑–∞ –º—É—Å–æ—Ä–∫–æ–π, –≤—ã—Å—Ç–∞–≤–ª—è—Ç—å –º—É—Å–æ—Ä –∫ –≤—ã—Ö–æ–¥—É.
              12. –í—ã–º—ã—Ç—å –º—É—Å–æ—Ä–Ω–æ–µ –≤–µ–¥—Ä–æ.
              13. –°–ª–µ–¥–∏—Ç—å –∑–∞ –Ω–∞–ª–∏—á–∏–µ–º —Å—Ç–∏—Ä–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä–æ—à–∫–∞, –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–∞ –∏ Fairy.
              14. –í—ã–º—ã—Ç—å –º–∏–∫—Ä–æ–≤–æ–ª–Ω–æ–≤–∫—É –≤–Ω—É—Ç—Ä–∏.`);
});

bot.command(/–ß–µ–∫-–ª–∏—Å—Ç –ö–í–¢+$/i, ctx => {
  ctx.reply(`üö™ –ö–æ—Ä–∏–¥–æ—Ä:
            
            1. –ü—Ä–∏–≤–µ—Å—Ç–∏ –≤ –ø–æ—Ä—è–¥–æ–∫ –ø–æ–ª–∫—É —Å –ø–æ–ª–æ—Ç–µ–Ω—Ü–∞–º–∏ –∏ –ø–æ—Å—Ç–µ–ª—å–Ω—ã–º –±–µ–ª—å–µ–º + —Å—Ç–µ–ª–ª–∞–∂ —É –≤–∞–Ω–Ω—ã —Å —Å—É—Ö–æ–π –æ–¥–µ–∂–¥–æ–π.
            2. –ü–æ–¥–º–µ—Ç–∞—Ç—å –ø–æ–ª, —á—Ç–æ–±—ã –±—ã–ª–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ.
            3. –†–∞—Å—Å—Ç–∞–≤–ª—è—Ç—å —Ä–∞–∑–±—Ä–æ—Å–∞–Ω–Ω—ã–µ –±–æ—Ç–∏–Ω–∫–∏.
            4. –ü—Ä–æ—Ç–µ—Ä–µ—Ç—å –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏, —Ç—É–º–±–æ—á–∫—É, –∑–µ—Ä–∫–∞–ª–∞.
            
            üõÅ –í–∞–Ω–Ω–∞—è:
            
            1. –ü—Ä–æ—Ç–µ—Ä–µ—Ç—å –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏: –ø–æ–ª–æ—á–∫–∏, –∑–µ—Ä–∫–∞–ª–æ.
            2. –°–ª–µ–¥–∏—Ç—å, —á—Ç–æ–±—ã –≤–∞–Ω–Ω–∞—è –∏ —Ä–∞–∫–æ–≤–∏–Ω–∞ –±—ã–ª–∏ —á–∏—Å—Ç—ã–µ, –±–µ–∑ –ø—ã–ª–∏ –∏ –Ω–∞–ª–µ—Ç–∞.
            3. –í—ã–∫–∏–Ω—É—Ç—å –∏ –≤—ã–º—ã—Ç—å –º—É—Å–æ—Ä–Ω–æ–µ –≤–µ–¥—Ä–æ.
            4. –í—ã–º—ã—Ç—å –ø–æ–ª.
            5. –ü–æ–º—ã—Ç—å (—Å –º–æ—é—â–∏–º —Å—Ä–µ–¥—Å—Ç–≤–æ–º) –∫–∞—Ñ–µ–ª—å.
            
            üöΩ –¢—É–∞–ª–µ—Ç: 
            
            1. –í—ã–º—ã—Ç—å —É–Ω–∏—Ç–∞–∑, –≤ —Ç–æ–º —á–∏—Å–ª–µ —Å–Ω–∏–∑—É, —É –æ—Å–Ω–æ–≤–∞–Ω–∏—è.
            2. –°–ª–µ–¥–∏—Ç—å –∑–∞ –Ω–∞–ª–∏—á–∏–µ–º —Ç—É–∞–ª–µ—Ç–Ω–æ–π –±—É–º–∞–≥–∏.
            3. –í—ã–º—ã—Ç—å –ø–æ–ª (–≤–æ–∑–º–æ–∂–Ω–æ, –ø–∞—Ä—É —Ä–∞–∑).`);
});

const checkAndRemindSchedule = schedule.scheduleJob('00 18 * * *', async function() {
  await checkAndRemindDuties(bot);
});

app.use(expressLogger);

app.use(bodyParser.json());

app.post('/', bot.webhookCallback);

app.listen(process.env.PORT || 3000);
