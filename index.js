require('dotenv').config()
const express = require('express');
const bodyParser = require('body-parser');
const VkBot = require('node-vk-bot-api/lib');
const Markup = require('node-vk-bot-api/lib/markup');
const Session = require('node-vk-bot-api/lib/session');
const Stage = require('node-vk-bot-api/lib/stage');
const { getCurrentDuties } = require('./commands');
const { fillScheduleByLastDuties } = require('./commands');
const { changeDuties } = require('./scenes');


const logger = require('./logger');
const expressPino = require('express-pino-logger');
const expressLogger = expressPino({ logger });

const app = express();
const bot = new VkBot({
    token: process.env.VK_TOKEN,
    confirmation: process.env.VK_CONFIRM
});
const session = new Session();
const stage = new Stage(changeDuties);

bot.use(session.middleware());

bot.use(stage.middleware());

bot.command(/ÐœÐµÐ½ÑŽ+$/i, ctx => {
    ctx.reply('Ð’Ñ‹Ð±ÐµÑ€Ð¸ Ñ€Ð°Ð·Ð´ÐµÐ»:', null, Markup
      .keyboard([
        [
          Markup.button('Ð”ÐµÐ¶ÑƒÑ€ÑÑ‚Ð²Ð°', 'primary'),
          Markup.button('Ð Ð°Ð·Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹', 'primary')
        ],
        [
          Markup.button('Ð‘Ð°Ð½Ðº', 'primary'),
          Markup.button('ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ', 'primary')
        ]
      ])
    );
});

bot.command(/Ð”ÐµÐ¶ÑƒÑ€ÑÑ‚Ð²Ð°+$/i, ctx => {
  try {
    ctx.reply('Ð’Ñ‹Ð±ÐµÑ€Ð¸ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ:', null, Markup
      .keyboard([
        [
          Markup.button('ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ñ…', 'positive'),
          Markup.button('Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ñ…', 'negative')
        ],
        [
          Markup.button('ÐÐ²Ñ‚Ð¾Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð³Ñ€Ð°Ñ„Ð¸ÐºÐ°'),
          Markup.button({
            action: {
              type: 'open_link',
              link: `https://docs.google.com/spreadsheets/d/${process.env.SPREADSHEET_ID}`,
              label: 'ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð³ÑƒÐ³Ð»-Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ',
              payload: JSON.stringify({ url: `https://docs.google.com/spreadsheets/d/${process.env.SPREADSHEET_ID}` })
            }
          }),
        ],
        [
          Markup.button('Ð§ÐµÐº-Ð»Ð¸ÑÑ‚ ÐºÑƒÑ…Ð½Ð¸'),
          Markup.button('Ð§ÐµÐº-Ð»Ð¸ÑÑ‚ ÐšÐ’Ð¢'),
          Markup.button('ÐœÐµÐ½ÑŽ', 'primary'),
        ]
      ])
    );
  } catch (error) {
    logger.error(error);
  }
});

bot.command(/ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ\sÑ‚ÐµÐºÑƒÑ‰Ð¸Ñ…+$/i, getCurrentDuties);

bot.command(/ÐÐ²Ñ‚Ð¾Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ\sÐ³Ñ€Ð°Ñ„Ð¸ÐºÐ°+$/i, fillScheduleByLastDuties);

bot.command(/Ð¢ÐµÑÑ‚+$/i, ctx => {
    ctx.reply('Ð ÐµÐ±ÑÑ‚Ð° Ð½Ðµ ÑÑ‚Ð¾Ð¸Ñ‚ Ð²ÑÐºÑ€Ñ‹Ð²Ð°Ñ‚ÑŒ ÑÑ‚Ñƒ Ñ‚ÐµÐ¼Ñƒ. Ð’Ñ‹ Ð¼Ð¾Ð»Ð¾Ð´Ñ‹Ðµ, ÑˆÑƒÑ‚Ð»Ð¸Ð²Ñ‹Ðµ, Ð²Ð°Ð¼ Ð²ÑÐµ Ð»ÐµÐ³ÐºÐ¾. Ð­Ñ‚Ð¾ Ð½Ðµ Ñ‚Ð¾. Ð­Ñ‚Ð¾ Ð½Ðµ Ð§Ð¸ÐºÐ°Ñ‚Ð¸Ð»Ð¾ Ð¸ Ð´Ð°Ð¶Ðµ Ð½Ðµ Ð°Ñ€Ñ…Ð¸Ð²Ñ‹ ÑÐ¿ÐµÑ†ÑÐ»ÑƒÐ¶Ð±. Ð¡ÑŽÐ´Ð° Ð»ÑƒÑ‡ÑˆÐµ Ð½Ðµ Ð»ÐµÐ·Ñ‚ÑŒ. Ð¡ÐµÑ€ÑŒÐµÐ·Ð½Ð¾, Ð»ÑŽÐ±Ð¾Ð¹ Ð¸Ð· Ð²Ð°Ñ Ð±ÑƒÐ´ÐµÑ‚ Ð¶Ð°Ð»ÐµÑ‚ÑŒ. Ð›ÑƒÑ‡ÑˆÐµ Ð·Ð°ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ñ‚ÐµÐ¼Ñƒ Ð¸ Ð·Ð°Ð±ÑƒÐ´ÑŒÑ‚Ðµ Ñ‡Ñ‚Ð¾ Ñ‚ÑƒÑ‚ Ð¿Ð¸ÑÐ°Ð»Ð¾ÑÑŒ. Ð¯ Ð²Ð¿Ð¾Ð»Ð½Ðµ Ð¿Ð¾Ð½Ð¸Ð¼Ð°ÑŽ Ñ‡Ñ‚Ð¾ Ð´Ð°Ð½Ð½Ñ‹Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÐµÐ¼ Ð²Ñ‹Ð·Ð¾Ð²Ñƒ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑ, Ð½Ð¾ Ñ…Ð¾Ñ‡Ñƒ ÑÑ€Ð°Ð·Ñƒ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚ÐµÑ€ÐµÑ‡ÑŒ Ð¿Ñ‹Ñ‚Ð»Ð¸Ð²Ñ‹Ñ… - ÑÑ‚Ð¾Ð¿. ÐžÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð½Ðµ Ð½Ð°Ð¹Ð´ÑƒÑ‚.');
});

bot.command(/Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ñ…+$/i, ctx => {
  ctx.scene.enter('Change Duties');
});

bot.command(/Ð§ÐµÐº-Ð»Ð¸ÑÑ‚ ÐºÑƒÑ…Ð½Ð¸+$/i, ctx => {
  ctx.reply(`ðŸ½ ÐšÑƒÑ…Ð½Ñ:

              1. Ð’Ñ‹Ð¼Ñ‹Ñ‚ÑŒ Ñ€Ð°ÐºÐ¾Ð²Ð¸Ð½Ñƒ Ñ Ð¼Ð¾ÑŽÑ‰Ð¸Ð¼ ÑÑ€ÐµÐ´ÑÑ‚Ð²Ð¾Ð¼.
              2. Ð’Ñ‹Ð¼Ñ‹Ñ‚ÑŒ ÑÑƒÑˆÐ¸Ð»ÐºÐ¸-Ð¿Ð¾Ð´ÑÑ‚Ð°Ð²ÐºÐ¸ Ð´Ð»Ñ Ð»Ð¾Ð¶ÐµÐº Ð¸ Ð²Ð¸Ð»Ð¾Ðº.
              3. Ð£Ð±Ñ€Ð°Ñ‚ÑŒÑÑ (Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²ÑÐµ Ð»ÐµÐ¶Ð°Ð»Ð¾ Ð°ÐºÐºÑƒÑ€Ð°Ñ‚Ð½Ð¾) Ð½Ð° Ð¿Ð¾Ð´Ð¾ÐºÐ¾Ð½Ð½Ð¸ÐºÐµ Ð¸ Ð½Ð° Ð¿Ð¾Ð»ÐºÐµ Ð½Ð°Ð´ ÑÑ‚Ð¸Ñ€Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð¼Ð°ÑˆÐ¸Ð½Ð¾Ð¹.
              4. Ð£Ð±Ñ€Ð°Ñ‚ÑŒÑÑ (Ð¿Ñ€Ð¾Ñ‚ÐµÑ€ÐµÑ‚ÑŒ Ð¸ Ð°ÐºÐºÑƒÑ€Ð°Ñ‚Ð½Ð¾ Ñ€Ð°ÑÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ) Ð½Ð° Ð¿Ð¾Ð»ÐºÐ°Ñ… - Ñ Ñ‡Ð°ÐµÐ¼, ÑÐ¿ÐµÑ†Ð¸ÑÐ¼Ð¸.
              5. Ð¥Ð¾Ð»Ð¾Ð´Ð¸Ð»ÑŒÐ½Ð¸Ðº Ð²Ñ‹Ð¼Ñ‹Ñ‚ÑŒ Ð²Ð½ÑƒÑ‚Ñ€Ð¸, ÑÐ½Ð°Ñ€ÑƒÐ¶Ð¸ Ð¸ Ð²Ñ‹ÐºÐ¸Ð½ÑƒÑ‚ÑŒ Ð³Ð½Ð¸Ð»Ñ‹Ðµ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹, ÑÐ»ÐµÐ´Ð¸Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²ÑÐµ Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¾ÑÑŒ Ð°ÐºÐºÑƒÑ€Ð°Ñ‚Ð½Ð¾.
              6. Ð¢Ñƒ Ð¿Ð¾ÑÑƒÐ´Ñƒ, ÐºÐ¾Ñ‚Ð¾Ñ€ÑƒÑŽ Ð·Ð°Ð±Ñ‹Ð²Ð°ÑŽÑ‚ Ð¿Ð¾Ð¼Ñ‹Ñ‚ÑŒ, Ð¼Ñ‹Ñ‚ÑŒ (ÑÑ‚Ð¾ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð¿Ð¾Ñ‡Ñ‚Ð¸).
              7. ÐŸÑ€Ð¾Ñ‚Ð¸Ñ€Ð°Ñ‚ÑŒ Ð¿Ð¾Ð²ÐµÑ€Ñ…Ð½Ð¾ÑÑ‚Ð¸, Ð¿Ð¾Ð´Ð¾ÐºÐ¾Ð½Ð½Ð¸Ðº, ÑÑ‚Ð¸Ñ€Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð¼Ð°ÑˆÐ¸Ð½Ñƒ (Ð²Ð½ÑƒÑ‚Ñ€Ð¸ Ð¼Ñ‹Ñ‚ÑŒ Ñ‚Ð¾Ð¶Ðµ).
              8. Ð£Ð±Ð¸Ñ€Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð´ Ñ€Ð°ÐºÐ¾Ð²Ð¸Ð½Ð¾Ð¹.
              9. Ð’Ñ‹Ð¼Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð».
              10. ÐŸÐ¾Ð´Ð¼ÐµÑ‚Ð°Ñ‚ÑŒ Ð¿Ð¾Ð», Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð±Ñ‹Ð»Ð¾ Ð¾ÑÑ‚Ð°Ñ‚ÐºÐ¾Ð² ÐµÐ´Ñ‹.
              11. Ð¡Ð»ÐµÐ´Ð¸Ñ‚ÑŒ Ð·Ð° Ð¼ÑƒÑÐ¾Ñ€ÐºÐ¾Ð¹, Ð²Ñ‹ÑÑ‚Ð°Ð²Ð»ÑÑ‚ÑŒ Ð¼ÑƒÑÐ¾Ñ€ Ðº Ð²Ñ‹Ñ…Ð¾Ð´Ñƒ.
              12. Ð’Ñ‹Ð¼Ñ‹Ñ‚ÑŒ Ð¼ÑƒÑÐ¾Ñ€Ð½Ð¾Ðµ Ð²ÐµÐ´Ñ€Ð¾.
              13. Ð¡Ð»ÐµÐ´Ð¸Ñ‚ÑŒ Ð·Ð° Ð½Ð°Ð»Ð¸Ñ‡Ð¸ÐµÐ¼ ÑÑ‚Ð¸Ñ€Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¿Ð¾Ñ€Ð¾ÑˆÐºÐ°, ÐºÐ¾Ð½Ð´Ð¸Ñ†Ð¸Ð¾Ð½ÐµÑ€Ð° Ð¸ Fairy.
              14. Ð’Ñ‹Ð¼Ñ‹Ñ‚ÑŒ Ð¼Ð¸ÐºÑ€Ð¾Ð²Ð¾Ð»Ð½Ð¾Ð²ÐºÑƒ Ð²Ð½ÑƒÑ‚Ñ€Ð¸.`);
});

bot.command(/Ð§ÐµÐº-Ð»Ð¸ÑÑ‚ ÐšÐ’Ð¢+$/i, ctx => {
  ctx.reply(`ðŸšª ÐšÐ¾Ñ€Ð¸Ð´Ð¾Ñ€:
            
            1. ÐŸÑ€Ð¸Ð²ÐµÑÑ‚Ð¸ Ð² Ð¿Ð¾Ñ€ÑÐ´Ð¾Ðº Ð¿Ð¾Ð»ÐºÑƒ Ñ Ð¿Ð¾Ð»Ð¾Ñ‚ÐµÐ½Ñ†Ð°Ð¼Ð¸ Ð¸ Ð¿Ð¾ÑÑ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼ Ð±ÐµÐ»ÑŒÐµÐ¼ + ÑÑ‚ÐµÐ»Ð»Ð°Ð¶ Ñƒ Ð²Ð°Ð½Ð½Ñ‹ Ñ ÑÑƒÑ…Ð¾Ð¹ Ð¾Ð´ÐµÐ¶Ð´Ð¾Ð¹.
            2. ÐŸÐ¾Ð´Ð¼ÐµÑ‚Ð°Ñ‚ÑŒ Ð¿Ð¾Ð», Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð±Ñ‹Ð»Ð¾ Ð°ÐºÐºÑƒÑ€Ð°Ñ‚Ð½Ð¾.
            3. Ð Ð°ÑÑÑ‚Ð°Ð²Ð»ÑÑ‚ÑŒ Ñ€Ð°Ð·Ð±Ñ€Ð¾ÑÐ°Ð½Ð½Ñ‹Ðµ Ð±Ð¾Ñ‚Ð¸Ð½ÐºÐ¸.
            4. ÐŸÑ€Ð¾Ñ‚ÐµÑ€ÐµÑ‚ÑŒ Ð¿Ð¾Ð²ÐµÑ€Ñ…Ð½Ð¾ÑÑ‚Ð¸, Ñ‚ÑƒÐ¼Ð±Ð¾Ñ‡ÐºÑƒ, Ð·ÐµÑ€ÐºÐ°Ð»Ð°.
            
            ðŸ› Ð’Ð°Ð½Ð½Ð°Ñ:
            
            1. ÐŸÑ€Ð¾Ñ‚ÐµÑ€ÐµÑ‚ÑŒ Ð¿Ð¾Ð²ÐµÑ€Ñ…Ð½Ð¾ÑÑ‚Ð¸: Ð¿Ð¾Ð»Ð¾Ñ‡ÐºÐ¸, Ð·ÐµÑ€ÐºÐ°Ð»Ð¾.
            2. Ð¡Ð»ÐµÐ´Ð¸Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ð°Ð½Ð½Ð°Ñ Ð¸ Ñ€Ð°ÐºÐ¾Ð²Ð¸Ð½Ð° Ð±Ñ‹Ð»Ð¸ Ñ‡Ð¸ÑÑ‚Ñ‹Ðµ, Ð±ÐµÐ· Ð¿Ñ‹Ð»Ð¸ Ð¸ Ð½Ð°Ð»ÐµÑ‚Ð°.
            3. Ð’Ñ‹ÐºÐ¸Ð½ÑƒÑ‚ÑŒ Ð¸ Ð²Ñ‹Ð¼Ñ‹Ñ‚ÑŒ Ð¼ÑƒÑÐ¾Ñ€Ð½Ð¾Ðµ Ð²ÐµÐ´Ñ€Ð¾.
            4. Ð’Ñ‹Ð¼Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð».
            5. ÐŸÐ¾Ð¼Ñ‹Ñ‚ÑŒ (Ñ Ð¼Ð¾ÑŽÑ‰Ð¸Ð¼ ÑÑ€ÐµÐ´ÑÑ‚Ð²Ð¾Ð¼) ÐºÐ°Ñ„ÐµÐ»ÑŒ.
            
            ðŸš½ Ð¢ÑƒÐ°Ð»ÐµÑ‚: 
            
            1. Ð’Ñ‹Ð¼Ñ‹Ñ‚ÑŒ ÑƒÐ½Ð¸Ñ‚Ð°Ð·, Ð² Ñ‚Ð¾Ð¼ Ñ‡Ð¸ÑÐ»Ðµ ÑÐ½Ð¸Ð·Ñƒ, Ñƒ Ð¾ÑÐ½Ð¾Ð²Ð°Ð½Ð¸Ñ.
            2. Ð¡Ð»ÐµÐ´Ð¸Ñ‚ÑŒ Ð·Ð° Ð½Ð°Ð»Ð¸Ñ‡Ð¸ÐµÐ¼ Ñ‚ÑƒÐ°Ð»ÐµÑ‚Ð½Ð¾Ð¹ Ð±ÑƒÐ¼Ð°Ð³Ð¸.
            3. Ð’Ñ‹Ð¼Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð» (Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾, Ð¿Ð°Ñ€Ñƒ Ñ€Ð°Ð·).`);
});

bot.on(ctx => {
  logger.info(ctx);
});

app.use(expressLogger);

app.use(bodyParser.json());

app.post('/', bot.webhookCallback);

app.listen(process.env.PORT || 3000);
